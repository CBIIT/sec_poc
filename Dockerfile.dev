FROM rocker/r-ver:4 AS build

VOLUME ["/opt/R/sec_poc_workspace/sec_poc", "/opt/R/sec_poc_workspace/sec_admin"

WORKDIR /opt/R/sec_poc_workspace

# set location of renv cache
ENV RENV_PATHS_CACHE=/root/.cache/R/renv
ENV DEBIAN_FRONTEND=noninteractive

RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt \
    apt update && \
    # these packages are mentioned in the renv.lock file and a warning is generated by renv if missing
    apt install -y \
        gdal-bin \
        libcurl4-openssl-dev \
        libgdal-dev \
        libicu-dev \
        libpng-dev \
        libpq-dev \
        libssl-dev \
        pandoc && \
    R -e "install.packages('renv', repos = c(CRAN = 'https://cloud.r-project.org'))"

# copy renv files
COPY sec_poc/renv sec_poc/renv
COPY sec_poc/renv.lock sec_poc/
COPY sec_poc/.Rprofile sec_poc/

COPY sec_admin/renv sec_admin/renv
COPY sec_admin/renv.lock sec_admin/
COPY sec_admin/.Rprofile sec_admin/

# renv restore from cache
RUN --mount=type=cache,target=${RENV_PATHS_CACHE} \
    cd sec_poc \
    && R -e "renv::restore()" \
    && cd ../sec_admin \
    && R -e "renv::restore()"

COPY ./sec_poc.code-workspace .

CMD [ "sleep", "infinity" ]
