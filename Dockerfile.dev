FROM rocker/r-ver:4.4.3

VOLUME [ "/opt/R/sec_poc_workspace/sec_poc", "/opt/R/sec_poc_workspace/sec_admin" ]

WORKDIR /opt/R/sec_poc_workspace

# set location of renv cache
ENV RENV_PATHS_CACHE=/root/.cache/R/renv
ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && \
    # these packages are mentioned in the renv.lock file and a warning is generated by renv if missing
    apt install -y \
        gdal-bin \
        libcurl4-openssl-dev \
        libgdal-dev \
        libicu-dev \
        libpng-dev \
        libpq-dev \
        libssl-dev \
        pandoc && \
    R -e "install.packages('renv', repos = c(CRAN = 'https://cloud.r-project.org'))"

# copy renv files
COPY sec_poc/renv.lock sec_poc/

COPY sec_admin/renv.lock sec_admin/

# renv restore from cache
RUN --mount=type=cache,target=${RENV_PATHS_CACHE} \
    cd sec_poc \
    && R -e "renv::restore()" \
    && cd ../sec_admin \
    && R -e "renv::restore()"

COPY ./sec_poc.code-workspace .

CMD [ "sleep", "infinity" ]


# 1) Separate renv project libs for sec_poc and sec_admin (slow startup, but isolate)
#  - cache mounts don't persist in the container so symlinks cannnot be used (must be copied)
#  - use renv::isolate() to copy from cache to project lib
#  - requires renv activation script (slow)
# 2) Shared renv project libs for both (fast startup, works in both dev/prod without overwriting by mounts, not isolate)
#  - only provide the renv.lock file
#  - calling renv::restore() alone is sufficient
